<%+header%>
<h2><%:Interface Monitor Logs%></h2>
<%
local fs = require "nixio.fs"
local http = require "luci.http"
local log_dir = "/var/log/interface_monitor"
local files = {}
for f in fs.dir(log_dir) do
    if f:match("%.log$") or f:match("%.log%.old$") then
        table.insert(files, f)
    end
end
table.sort(files, function(a,b) return a > b end) -- Newest first

local current_file = http.formvalue("file") or files[1]
local content = ""

-- Security check: ensure current_file is in the allowed file list
local is_valid_file = false
for _, f in ipairs(files) do
    if f == current_file then
        is_valid_file = true
        break
    end
end

if is_valid_file and fs.access(log_dir .. "/" .. current_file) then
    local fp = io.open(log_dir .. "/" .. current_file, "r")
    if fp then
        content = fp:read("*a")
        fp:close()
    end
else
    current_file = nil -- Reset if invalid
end
%>

<div class="cbi-section">
    <div class="cbi-section-descr">
        <form action="<%=luci.dispatcher.build_url('admin/status/interface_monitor/logs')%>" method="get">
            <label><%:Select Log File:%>
                <select name="file" onchange="this.form.submit()">
                    <% for _,f in ipairs(files) do %>
                        <option value="<%=f%>" <%=f == current_file and "selected" or ""%>><%=f%></option>
                    <% end %>
                </select>
            </label>
            <input type="submit" class="cbi-button cbi-button-apply" value="<%:Refresh%>" />
        </form>
    </div>
    
    <% if current_file then %>
    <h3><%=current_file%></h3>
    <textarea style="width: 100%; height: 600px; font-family: monospace;" readonly="readonly" wrap="off"><%=content%></textarea>
    <% else %>
    <p><%:No log files found.%></p>
    <% end %>
</div>

<%+footer%>

