<%+header%>
<style>
  .modern-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
  .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
  .control-group { display: flex; flex-direction: column; gap: 5px; }
  .control-group label { font-size: 12px; font-weight: bold; color: #555; }
  select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; min-width: 200px; }
  .btn-danger { background: #d32f2f; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 500; margin-left: auto; }
  
  .event-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  .event-table th { text-align: left; padding: 12px; background: #f5f5f5; color: #666; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #ddd; }
  .event-table td { padding: 12px; border-bottom: 1px solid #eee; color: #333; font-size: 14px; }
  .event-table tr:hover { background: #f9f9f9; }
  
  .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: #fff; }
  .badge-init { background: #1976d2; }
  .badge-update { background: #fbc02d; color: #333; }
  .badge-unknown { background: #9e9e9e; }
  
  .state-change { font-family: monospace; }
  .state-old { color: #d32f2f; text-decoration: line-through; margin-right: 5px; }
  .state-new { color: #388e3c; font-weight: bold; }
</style>

<h2><%:Interface Monitor%></h2>

<%
local fs = require "nixio.fs"
local http = require "luci.http"
local log_dir = "/tmp/log/interface_monitor"
local files = {}
for f in fs.dir(log_dir) do
    if f:match("^iface_.*%.log$") then
        table.insert(files, f)
    end
end
table.sort(files, function(a,b) return a > b end)
local current_file = http.formvalue("file") or files[1]
local content = ""
if current_file and fs.access(log_dir .. "/" .. current_file) then
    local fp = io.open(log_dir .. "/" .. current_file, "r")
    if fp then
        content = fp:read("*a")
        fp:close()
    end
end
%>

<div class="cbi-section">
  <div class="modern-card">
    <form method="get" action="<%=luci.dispatcher.build_url('admin/status/interface_monitor/iface')%>">
      <div class="controls">
        <div class="control-group">
          <label><%:Log File%></label>
          <select name="file" onchange="this.form.submit()">
            <% for _,f in ipairs(files) do %>
              <option value="<%=f%>" <%=f==current_file and "selected" or ""%>><%=f%></option>
            <% end %>
          </select>
        </div>
        <div class="control-group">
          <label><%:Filter Interface%></label>
          <select id="iface_select">
            <option value="all">All Interfaces</option>
          </select>
        </div>
        <button type="button" class="btn-danger" onclick="clearHistory()"><%:Clear History%></button>
      </div>
    </form>

    <% if current_file then %>
    <table class="event-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Interface</th>
          <th>Event</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="eventBody">
      </tbody>
    </table>
    
    <textarea id="raw" style="display:none"><%=content%></textarea>
    <% else %>
    <p><%:No interface log found.%></p>
    <% end %>
  </div>
</div>

<script>
(function(){
    var raw = document.getElementById('raw').value.split('\n');
    var events = [];
    var interfaces = new Set();
    
    for(var i=0; i<raw.length; i++){
        var line = raw[i];
        if(!line) continue;
        
        var ts, iface, event, details;
        var parts = line.split('|');
        
        if (parts.length >= 5) {
            // New Format: Timestamp|Interface|Event|OldState|NewState
            ts = parts[0];
            iface = parts[1];
            event = parts[2];
            var oldState = parts[3];
            var newState = parts[4];
            
            if(oldState === 'none') {
                details = '<span class="state-new">' + newState + '</span>';
            } else {
                details = '<span class="state-old">' + oldState + '</span> <span class="state-new">' + newState + '</span>';
            }
        } else {
            // Old Regex Format fallback
            var m = line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) State (\w+) (\S+) changed from (.*) to (.*)/);
            if(m) {
                ts = m[1];
                event = m[2]; 
                iface = m[3];
                var os = m[4];
                var ns = m[5];
                if(os === 'no state') {
                    details = '<span class="state-new">' + ns + '</span>';
                } else {
                    details = '<span class="state-old">' + os + '</span> <span class="state-new">' + ns + '</span>';
                }
            } else {
                continue;
            }
        }
        
        events.push({ts: ts, iface: iface, event: event, details: details});
        interfaces.add(iface);
    }
    
    // Populate Interface Select
    var ifaceSelect = document.getElementById('iface_select');
    var sortedIfaces = Array.from(interfaces).sort();
    sortedIfaces.forEach(function(iface){
        var opt = document.createElement('option');
        opt.value = iface;
        opt.text = iface;
        ifaceSelect.add(opt);
    });
    
    ifaceSelect.addEventListener('change', function(){
        renderTable(this.value);
    });
    
    var tbody = document.getElementById('eventBody');
    
    function renderTable(filterIface) {
        tbody.innerHTML = '';
        
        // Reverse order (newest first)
        for(var i = events.length - 1; i >= 0; i--) {
            var e = events[i];
            if(filterIface !== 'all' && e.iface !== filterIface) continue;
            
            var tr = document.createElement('tr');
            
            var tdTs = document.createElement('td');
            tdTs.innerText = e.ts;
            tr.appendChild(tdTs);
            
            var tdIface = document.createElement('td');
            tdIface.innerText = e.iface;
            tdIface.style.fontWeight = 'bold';
            tr.appendChild(tdIface);
            
            var tdEvent = document.createElement('td');
            var badgeClass = 'badge-unknown';
            if(e.event === 'init' || e.event === 'initialization') badgeClass = 'badge-init';
            if(e.event === 'update') badgeClass = 'badge-update';
            tdEvent.innerHTML = '<span class="badge ' + badgeClass + '">' + e.event + '</span>';
            tr.appendChild(tdEvent);
            
            var tdDetails = document.createElement('td');
            tdDetails.innerHTML = e.details;
            tdDetails.className = 'state-change';
            tr.appendChild(tdDetails);
            
            tbody.appendChild(tr);
        }
        
        if(tbody.children.length === 0) {
            var tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4" style="text-align:center; color:#999">No events found</td>';
            tbody.appendChild(tr);
        }
    }
    
    renderTable('all');
    
    window.clearHistory = function() {
        if(confirm('<%:Are you sure you want to delete all history logs?%>')) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '<%=luci.dispatcher.build_url("admin/status/interface_monitor/clear_logs")%>', true);
            xhr.onload = function() {
                if(xhr.status === 200) {
                    alert('<%:Logs cleared successfully.%>');
                    location.reload();
                } else {
                    alert('<%:Failed to clear logs.%>');
                }
            };
            xhr.send();
        }
    };
})();
</script>
<%+footer%>
