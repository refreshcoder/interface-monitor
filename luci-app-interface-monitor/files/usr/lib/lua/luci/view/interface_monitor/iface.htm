<%+header%>
<h2><%:Interface Graph%></h2>
<%
local fs = require "nixio.fs"
local http = require "luci.http"
local log_dir = "/tmp/log/interface_monitor"
local files = {}
for f in fs.dir(log_dir) do
    if f:match("^%d%d%d%d%-%d%d%-%d%d%.log$") then
        table.insert(files, f)
    end
end
table.sort(files, function(a,b) return a > b end)
local current_file = http.formvalue("file") or files[1]
local content = ""
if current_file and fs.access(log_dir .. "/" .. current_file) then
    local fp = io.open(log_dir .. "/" .. current_file, "r")
    if fp then
        content = fp:read("*a")
        fp:close()
    end
end
%>
<div class="cbi-section">
  <div class="cbi-section-descr">
    <form method="get" action="<%=luci.dispatcher.build_url('admin/status/interface_monitor/iface')%>">
      <label><%:Log File%>
        <select name="file" style="min-width:220px">
          <% for _,f in ipairs(files) do %>
            <option value="<%=f%>" <%=f==current_file and "selected" or ""%>><%=f%></option>
          <% end %>
        </select>
      </label>
      <label style="margin-left:16px"><%:Interface%>
        <input type="text" name="iface" value="<%=http.formvalue('iface') or ''%>" placeholder="e.g. eth0"/>
      </label>
      <label style="margin-left:16px"><%:Range%>
        <select name="range">
          <option value="60">1h</option>
          <option value="360">6h</option>
          <option value="1440" selected>24h</option>
          <option value="0">All</option>
        </select>
      </label>
      <input type="submit" class="cbi-button cbi-button-apply" value="<%:Apply%>" />
    </form>
  </div>
  <% if current_file then %>
  <h3><%=current_file%></h3>
  <canvas id="chart" width="900" height="320" style="border:1px solid #ccc"></canvas>
  <div>
    <span style="color:#1976d2">Speed(Mbps)</span>
    <span style="color:#d32f2f; margin-left:16px">Down events</span>
  </div>
  <textarea id="raw" style="display:none"><%=content%></textarea>
  <script>
  (function(){
    var raw=document.getElementById('raw').value.split('\n');
    var iface=(new URLSearchParams(location.search)).get('iface')||'';
    var range=parseInt((new URLSearchParams(location.search)).get('range')||'1440');
    var points=[];
    function parseSpeed(s){
      if(!s) return 0;
      if(/Gb\/s/i.test(s)){ return parseFloat(s)*1000; }
      var m=s.match(/([0-9.]+)Mb\/s/i); return m?parseFloat(m[1]):0;
    }
    for(var i=0;i<raw.length;i++){
      var line=raw[i]; if(!line) continue;
      var m=line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}).* (State (?:init|update)) (\S+) .* to ([^ ]+) ([^ ]+)/);
      if(m){
        var ts=m[1], type=m[2], ifn=m[3], sp=m[4], link=m[5];
        if(iface && ifn!==iface) continue;
        var speed=parseSpeed(sp);
        var down=(link.toLowerCase()==='no');
        points.push({ts:ts,speed:speed,down:down});
      }
    }
    if(points.length===0){ return; }
    var now=new Date(points[points.length-1].ts.replace(' ','T')).getTime();
    if(range>0){
      var cutoff=now - range*60*1000;
      points=points.filter(function(p){ return new Date(p.ts.replace(' ','T')).getTime()>=cutoff; });
    }
    var c=document.getElementById('chart'); var ctx=c.getContext('2d');
    var pw=c.width, ph=c.height, lm=50, bm=30, rw=pw-lm, rh=ph-bm;
    var maxS=0; for(var i=0;i<points.length;i++){ if(points[i].speed>maxS) maxS=points[i].speed; }
    if(maxS<=0) maxS=1;
    ctx.clearRect(0,0,pw,ph);
    ctx.strokeStyle='#e0e0e0'; ctx.beginPath(); ctx.moveTo(lm,0); ctx.lineTo(lm,ph-bm); ctx.lineTo(pw,ph-bm); ctx.stroke();
    function x(i){ return lm + (i*(rw/(points.length-1))); }
    function ys(v){ return (ph-bm) - (v/maxS)*rh; }
    ctx.strokeStyle='#1976d2'; ctx.beginPath(); ctx.moveTo(x(0), ys(points[0].speed));
    for(var i=1;i<points.length;i++){ ctx.lineTo(x(i), ys(points[i].speed)); }
    ctx.stroke();
    ctx.fillStyle='#d32f2f';
    var downCount=0;
    for(var i=0;i<points.length;i++){
      if(points[i].down){ downCount++; ctx.beginPath(); ctx.arc(x(i), ys(points[i].speed), 3, 0, 2*Math.PI); ctx.fill(); }
    }
    ctx.fillStyle='#000'; ctx.fillText('Down events: '+downCount, lm+8, 14);
    var tickN=6; for(var t=0;t<tickN;t++){ var idx=Math.floor(t*(points.length-1)/(tickN-1)); var d=new Date(points[idx].ts.replace(' ','T')); var label=d.toLocaleTimeString(); ctx.fillText(label, x(idx)-20, ph-12); }
    var step=Math.max(1, Math.round(maxS/5)); for(var v=0; v<=maxS; v+=step){ var yy=ys(v); ctx.fillText(v.toFixed(0), 4, yy+4); }
  })();
  </script>
  <% else %>
  <p><%:No interface log found.%></p>
  <% end %>
</div>
<%+footer%>
