<%+header%>
<style>
  .modern-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
  .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
  .control-group { display: flex; flex-direction: column; gap: 5px; }
  .control-group label { font-size: 12px; font-weight: bold; color: #555; }
  select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; min-width: 200px; }
  .btn-danger { background: #d32f2f; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 500; margin-left: auto; }
  .port-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; margin-top: 10px; }
  .port-card { background: #e9ecef; border-radius: 6px; padding: 12px; display: flex; flex-direction: column; align-items: flex-start; position: relative; }
  .port-icon { width: 48px; height: 30px; background: linear-gradient(#444, #222); border-radius: 4px; position: relative; margin-bottom: 8px; }
  .port-status-dot { position: absolute; left: 4px; bottom: 4px; width: 8px; height: 8px; border-radius: 50%; background: #4caf50; }
  .port-speed { font-size: 12px; color: #666; margin-bottom: 2px; }
  .port-name { font-size: 14px; color: #333; }
  
  .event-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  .event-table th { text-align: left; padding: 12px; background: #f5f5f5; color: #666; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #ddd; }
  .event-table td { padding: 12px; border-bottom: 1px solid #eee; color: #333; font-size: 14px; }
  .event-table tr:hover { background: #f9f9f9; }
  
  .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: #fff; }
  .badge-init { background: #1976d2; }
  .badge-update { background: #fbc02d; color: #333; }
  .badge-unknown { background: #9e9e9e; }
  
  .state-change { font-family: monospace; }
  .state-old { color: #d32f2f; text-decoration: line-through; margin-right: 5px; }
  .state-new { color: #388e3c; font-weight: bold; }
</style>

<h2><%:Interface Monitor%></h2>

<%
local http = require "luci.http"
local current_file = "iface.log"
%>

<div class="cbi-section">
  <div class="modern-card">
    <form method="get" action="<%=luci.dispatcher.build_url('admin/status/interface_monitor/iface')%>">
      <div class="controls">

        <div class="control-group">
          <label><%:Filter Interface%></label>
          <select id="iface_select">
            <option value="all">All Interfaces</option>
          </select>
        </div>
        <button type="button" class="btn-danger" onclick="clearHistory()"><%:Clear History%></button>
      </div>
    </form>

    <% if current_file then %>
    <div class="port-grid" id="portGrid"></div>
    <table class="event-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Interface</th>
          <th>Event</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="eventBody">
      </tbody>
    </table>
    <% else %>
    <p><%:No interface log found.%></p>
    <% end %>
  </div>
</div>

<script>
(function(){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=luci.dispatcher.build_url("admin/status/interface_monitor/get_log_data")%>?file=<%=current_file%>', true);
    xhr.onload = function() {
        if (xhr.status === 200) {
            var raw = JSON.parse(xhr.responseText);
            var events = [];
            var interfaces = new Set();
            
            for(var i=0; i<raw.length; i++){
                var line = raw[i];
                if(!line) continue;
                
                var ts, iface, event, details;
                var parts = line.split('|');
                
                if (parts.length >= 5) {
                    // New Format: Timestamp|Interface|Event|OldState|NewState
                    ts = parts[0];
                    iface = parts[1];
                    event = parts[2];
                    var oldState = parts[3];
                    var newState = parts[4];
                    
                    if(oldState === 'none') {
                        details = '<span class="state-new">' + newState + '</span>';
                    } else {
                        details = '<span class="state-old">' + oldState + '</span> <span class="state-new">' + newState + '</span>';
                    }
                } else {
                    // Old Regex Format fallback
                    var m = line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) State (\w+) (\S+) changed from (.*) to (.*)/);
                    if(m) {
                        ts = m[1];
                        event = m[2]; 
                        iface = m[3];
                        var os = m[4];
                        var ns = m[5];
                        if(os === 'no state') {
                            details = '<span class="state-new">' + ns + '</span>';
                        } else {
                            details = '<span class="state-old">' + os + '</span> <span class="state-new">' + ns + '</span>';
                        }
                    } else {
                        continue;
                    }
                }
                
                events.push({ts: ts, iface: iface, event: event, details: details, state: newState});
                interfaces.add(iface);
            }
            
            // Populate Interface Select
            var ifaceSelect = document.getElementById('iface_select');
            var sortedIfaces = Array.from(interfaces).sort();
            sortedIfaces.forEach(function(iface){
                var opt = document.createElement('option');
                opt.value = iface;
                opt.text = iface;
                ifaceSelect.add(opt);
            });
            
            ifaceSelect.addEventListener('change', function(){
                renderTable(this.value);
            });
            
            var tbody = document.getElementById('eventBody');
            
            function renderTable(filterIface) {
                tbody.innerHTML = '';
                
                // Reverse order (newest first)
                for(var i = events.length - 1; i >= 0; i--) {
                    var e = events[i];
                    if(filterIface !== 'all' && e.iface !== filterIface) continue;
                    
                    var tr = document.createElement('tr');
                    
                    var tdTs = document.createElement('td');
                    tdTs.innerText = e.ts;
                    tr.appendChild(tdTs);
                    
                    var tdIface = document.createElement('td');
                    tdIface.innerText = e.iface;
                    tdIface.style.fontWeight = 'bold';
                    tr.appendChild(tdIface);
                    
                    var tdEvent = document.createElement('td');
                    var badgeClass = 'badge-unknown';
                    if(e.event === 'init' || e.event === 'initialization') badgeClass = 'badge-init';
                    if(e.event === 'update') badgeClass = 'badge-update';
                    tdEvent.innerHTML = '<span class="badge ' + badgeClass + '">' + e.event + '</span>';
                    tr.appendChild(tdEvent);
                    
                    var tdDetails = document.createElement('td');
                    tdDetails.innerHTML = e.details;
                    tdDetails.className = 'state-change';
                    tr.appendChild(tdDetails);
                    
                    tbody.appendChild(tr);
                }
                
                if(tbody.children.length === 0) {
                    var tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="4" style="text-align:center; color:#999">No events found</td>';
                    tbody.appendChild(tr);
                }
            }
            
            renderTable('all');

            function renderPortGrid(realtimeStatus) {
                var grid = document.getElementById('portGrid');
                grid.innerHTML = '';

                var interfacesToRender = realtimeStatus ? Object.keys(realtimeStatus) : Array.from(interfaces);
                interfacesToRender.sort();

                interfacesToRender.forEach(function(iface){
                    var info = realtimeStatus ? realtimeStatus[iface] : latest[iface];
                    var speedText = 'Unknown';
                    var linkUp = false;

                    if (info) {
                        linkUp = info.up || false;
                        if (linkUp && info.speed) {
                            speedText = info.speed + ' Mbit/s';
                        } else if (!linkUp) {
                            speedText = 'Disconnected';
                        }
                    }

                    var card = document.createElement('div');
                    card.className = 'port-card';
                    var icon = document.createElement('div');
                    icon.className = 'port-icon';
                    var dot = document.createElement('div');
                    dot.className = 'port-status-dot';
                    dot.style.background = linkUp ? '#4caf50' : '#9e9e9e';
                    icon.appendChild(dot);
                    var speed = document.createElement('div');
                    speed.className = 'port-speed';
                    speed.innerText = speedText;
                    var name = document.createElement('div');
                    name.className = 'port-name';
                    name.innerText = iface;
                    card.appendChild(icon);
                    card.appendChild(speed);
                    card.appendChild(name);
                    grid.appendChild(card);
                });
            }

            function fetchInitialStatus() {
                var statusXhr = new XMLHttpRequest();
                statusXhr.open('GET', '<%=luci.dispatcher.build_url("admin/status/interface_monitor/get_interface_status")%>', true);
                statusXhr.onload = function() {
                    if (statusXhr.status === 200) {
                        var status = JSON.parse(statusXhr.responseText);
                        renderPortGrid(status);
                    }
                };
                statusXhr.send();
            }

            fetchInitialStatus();
        }
    };
    xhr.send();
    
    window.clearHistory = function() {
        if(confirm('<%:Are you sure you want to delete all history logs?%>')) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '<%=luci.dispatcher.build_url("admin/status/interface_monitor/clear_logs")%>', true);
            xhr.onload = function() {
                if(xhr.status === 200) {
                    alert('<%:Logs cleared successfully.%>');
                    location.reload();
                } else {
                    alert('<%:Failed to clear logs.%>');
                }
            };
            xhr.send();
        }
    };
})();
</script>
<%+footer%>
