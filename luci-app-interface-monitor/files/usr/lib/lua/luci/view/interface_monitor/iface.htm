<%+header%>
<style>
  :root {
    --cbi-background-color: #fff;
    --cbi-text-color: #333;
    --cbi-border-color: #ddd;
    --cbi-input-background-color: #fff;
    --cbi-input-border-color: #ccc;
    --cbi-button-background-color: #e9ecef;
    --cbi-button-text-color: #333;
    --cbi-card-background-color: #f8f9fa;
    --cbi-card-shadow-color: rgba(0,0,0,0.05);
    --cbi-table-header-background-color: #f5f5f5;
    --cbi-table-row-hover-background-color: #f9f9f9;
    --cbi-badge-init-background-color: #1976d2;
    --cbi-badge-update-background-color: #fbc02d;
    --cbi-badge-unknown-background-color: #9e9e9e;
    --cbi-danger-background-color: #d32f2f;
    --cbi-danger-hover-background-color: #b71c1c;
    --spacing-unit: 8px;
    --border-radius: 6px;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --cbi-background-color: #1e1e1e;
      --cbi-text-color: #ccc;
      --cbi-border-color: #444;
      --cbi-input-background-color: #2a2a2a;
      --cbi-input-border-color: #555;
      --cbi-button-background-color: #3a3a3a;
      --cbi-button-text-color: #eee;
      --cbi-card-background-color: #2c2c2c;
      --cbi-card-shadow-color: rgba(0,0,0,0.3);
      --cbi-table-header-background-color: #333;
      --cbi-table-row-hover-background-color: #383838;
      --cbi-badge-init-background-color: #2196f3;
      --cbi-badge-update-background-color: #ffca28;
      --cbi-badge-unknown-background-color: #757575;
      --cbi-danger-background-color: #e53935;
      --cbi-danger-hover-background-color: #c62828;
    }
  }

  body {
    background-color: var(--cbi-background-color);
    color: var(--cbi-text-color);
  }

  .modern-card { background: var(--cbi-card-background-color); border-radius: var(--border-radius); box-shadow: 0 2px 4px var(--cbi-card-shadow-color); padding: calc(var(--spacing-unit) * 2.5); margin-bottom: calc(var(--spacing-unit) * 2.5); }
  .controls { display: flex; gap: calc(var(--spacing-unit) * 2); align-items: center; flex-wrap: wrap; margin-bottom: calc(var(--spacing-unit) * 2.5); }
  .control-group { display: flex; flex-direction: column; gap: var(--spacing-unit); }
  .control-group label { font-size: 12px; font-weight: bold; color: var(--cbi-text-color); }
  select { padding: var(--spacing-unit); border: 1px solid var(--cbi-input-border-color); border-radius: var(--border-radius); background: var(--cbi-input-background-color); color: var(--cbi-text-color); min-width: 200px; }
  .btn-danger { background: var(--cbi-danger-background-color); color: #fff; border: none; padding: var(--spacing-unit) calc(var(--spacing-unit) * 2); border-radius: var(--border-radius); cursor: pointer; font-weight: 500; margin-left: auto; }
  .btn-danger:hover { background: var(--cbi-danger-hover-background-color); }
  .port-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: calc(var(--spacing-unit) * 2); margin-top: var(--spacing-unit); }
  .port-card { background: var(--cbi-background-color); border-radius: var(--border-radius); padding: calc(var(--spacing-unit) * 1.5); display: flex; flex-direction: column; align-items: flex-start; position: relative; border: 1px solid var(--cbi-border-color); }
  .port-icon { width: 48px; height: 30px; background: linear-gradient(#555, #333); border-radius: 4px; position: relative; margin-bottom: var(--spacing-unit); }
  .port-status-dot { position: absolute; left: 4px; bottom: 4px; width: var(--spacing-unit); height: var(--spacing-unit); border-radius: 50%; background: #4caf50; }
  .port-speed { font-size: 12px; color: var(--cbi-text-color); opacity: 0.7; margin-bottom: 2px; }
  .port-name { font-size: 14px; color: var(--cbi-text-color); font-weight: bold; }
  
  .event-table { width: 100%; border-collapse: collapse; margin-top: var(--spacing-unit); }
  .event-table th { text-align: left; padding: calc(var(--spacing-unit) * 1.5); background: var(--cbi-table-header-background-color); color: var(--cbi-text-color); font-size: 12px; text-transform: uppercase; border-bottom: 2px solid var(--cbi-border-color); }
  .event-table td { padding: calc(var(--spacing-unit) * 1.5); border-bottom: 1px solid var(--cbi-border-color); color: var(--cbi-text-color); font-size: 14px; }
  .event-table tr:hover { background: var(--cbi-table-row-hover-background-color); }
  
  .badge { display: inline-block; padding: calc(var(--spacing-unit) * 0.5) var(--spacing-unit); border-radius: var(--border-radius); font-size: 11px; font-weight: bold; color: #fff; }
  .badge-init { background: var(--cbi-badge-init-background-color); }
  .badge-update { background: var(--cbi-badge-update-background-color); color: #333; }
  .badge-unknown { background: var(--cbi-badge-unknown-background-color); }
  
  .state-change { font-family: monospace; }
  .state-old { color: #d32f2f; text-decoration: line-through; margin-right: var(--spacing-unit); }
  .state-new { color: #388e3c; font-weight: bold; }
</style>

<h2><%:Interface Monitor%></h2>

<%
local http = require "luci.http"
local current_file = "iface.log"
%>

<div class="cbi-section">
  <div class="modern-card">
    <form method="get" action="<%=luci.dispatcher.build_url('admin/status/interface_monitor/iface')%>">
      <div class="controls">

        <div class="control-group">
          <label><%:Filter Interface%></label>
          <select id="iface_select">
            <option value="all">All Interfaces</option>
          </select>
        </div>
        <button type="button" class="btn-danger" onclick="clearHistory()"><%:Clear History%></button>
      </div>
    </form>

    <% if current_file then %>
    <div class="port-grid" id="portGrid"></div>
    <table class="event-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Interface</th>
          <th>Event</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="eventBody">
      </tbody>
    </table>
    <% else %>
    <p><%:No interface log found.%></p>
    <% end %>
  </div>
</div>

<script>
(function(){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=luci.dispatcher.build_url("admin/status/interface_monitor/get_log_data")%>?file=<%=current_file%>', true);
    xhr.onload = function() {
        if (xhr.status === 200) {
            var raw = JSON.parse(xhr.responseText);
            var events = [];
            var interfaces = new Set();
            
            for(var i=0; i<raw.length; i++){
                var line = raw[i];
                if(!line) continue;
                
                var ts, iface, event, details;
                var parts = line.split('|');
                
                if (parts.length >= 5) {
                    // New Format: Timestamp|Interface|Event|OldState|NewState
                    ts = parts[0];
                    iface = parts[1];
                    event = parts[2];
                    var oldState = parts[3];
                    var newState = parts[4];
                    
                    if(oldState === 'none') {
                        details = '<span class="state-new">' + newState + '</span>';
                    } else {
                        details = '<span class="state-old">' + oldState + '</span> <span class="state-new">' + newState + '</span>';
                    }
                } else {
                    // Old Regex Format fallback
                    var m = line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) State (\w+) (\S+) changed from (.*) to (.*)/);
                    if(m) {
                        ts = m[1];
                        event = m[2]; 
                        iface = m[3];
                        var os = m[4];
                        var ns = m[5];
                        if(os === 'no state') {
                            details = '<span class="state-new">' + ns + '</span>';
                        } else {
                            details = '<span class="state-old">' + os + '</span> <span class="state-new">' + ns + '</span>';
                        }
                    } else {
                        continue;
                    }
                }
                
                events.push({ts: ts, iface: iface, event: event, details: details, state: newState});
                interfaces.add(iface);
            }
            
            // Populate Interface Select
            var ifaceSelect = document.getElementById('iface_select');
            var sortedIfaces = Array.from(interfaces).sort();
            sortedIfaces.forEach(function(iface){
                var opt = document.createElement('option');
                opt.value = iface;
                opt.text = iface;
                ifaceSelect.add(opt);
            });
            
            ifaceSelect.addEventListener('change', function(){
                renderTable(this.value);
            });
            
            var tbody = document.getElementById('eventBody');
            
            function renderTable(filterIface) {
                tbody.innerHTML = '';
                
                // Reverse order (newest first)
                for(var i = events.length - 1; i >= 0; i--) {
                    var e = events[i];
                    if(filterIface !== 'all' && e.iface !== filterIface) continue;
                    
                    var tr = document.createElement('tr');
                    
                    var tdTs = document.createElement('td');
                    tdTs.innerText = e.ts;
                    tr.appendChild(tdTs);
                    
                    var tdIface = document.createElement('td');
                    tdIface.innerText = e.iface;
                    tdIface.style.fontWeight = 'bold';
                    tr.appendChild(tdIface);
                    
                    var tdEvent = document.createElement('td');
                    var badgeClass = 'badge-unknown';
                    if(e.event === 'init' || e.event === 'initialization') badgeClass = 'badge-init';
                    if(e.event === 'update') badgeClass = 'badge-update';
                    tdEvent.innerHTML = '<span class="badge ' + badgeClass + '">' + e.event + '</span>';
                    tr.appendChild(tdEvent);
                    
                    var tdDetails = document.createElement('td');
                    tdDetails.innerHTML = e.details;
                    tdDetails.className = 'state-change';
                    tr.appendChild(tdDetails);
                    
                    tbody.appendChild(tr);
                }
                
                if(tbody.children.length === 0) {
                    var tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="4" style="text-align:center; color:#999">No events found</td>';
                    tbody.appendChild(tr);
                }
            }
            
            renderTable('all');

            function renderPortGrid(realtimeStatus) {
                var grid = document.getElementById('portGrid');
                grid.innerHTML = '';

                var interfacesToRender = realtimeStatus ? Object.keys(realtimeStatus) : Array.from(interfaces);
                interfacesToRender.sort();

                interfacesToRender.forEach(function(iface){
                    var info = realtimeStatus ? realtimeStatus[iface] : latest[iface];
                    var speedText = '<%:Unknown%>';
                    var linkUp = false;

                    if (info) {
                        linkUp = info.up || false;
                        if (linkUp && info.speed) {
                            speedText = info.speed + ' Mbit/s';
                        } else if (!linkUp) {
                            speedText = 'Disconnected';
                        }
                    }

                    var card = document.createElement('div');
                    card.className = 'port-card';
                    var icon = document.createElement('div');
                    icon.className = 'port-icon';
                    var dot = document.createElement('div');
                    dot.className = 'port-status-dot';
                    dot.style.background = linkUp ? '#4caf50' : '#9e9e9e';
                    icon.appendChild(dot);
                    var speed = document.createElement('div');
                    speed.className = 'port-speed';
                    speed.innerText = speedText;
                    var name = document.createElement('div');
                    name.className = 'port-name';
                    name.innerText = iface;
                    card.appendChild(icon);
                    card.appendChild(speed);
                    card.appendChild(name);
                    grid.appendChild(card);
                });
            }

            function fetchInitialStatus() {
                var statusXhr = new XMLHttpRequest();
                statusXhr.open('GET', '<%=luci.dispatcher.build_url("admin/status/interface_monitor/get_interface_status")%>', true);
                statusXhr.onload = function() {
                    if (statusXhr.status === 200) {
                        var status = JSON.parse(statusXhr.responseText);
                        renderPortGrid(status);
                    }
                };
                statusXhr.send();
            }

            fetchInitialStatus();
            filterConfiguredInterfaces();
        }
    };
    xhr.send();
    
    function filterConfiguredInterfaces() {
        fetch('<%=luci.dispatcher.build_url("admin/status/interface_monitor/get_configured_interfaces")%>')
            .then(response => response.json())
            .then(configuredInterfaces => {
                if (!Array.isArray(configuredInterfaces) || configuredInterfaces.length === 0) {
                    return; // Show all if nothing is configured
                }

                const portGrid = document.getElementById('portGrid');
                const ifaceSelect = document.getElementById('iface_select');
                const allPortCards = Array.from(portGrid.querySelectorAll('.port-card'));
                const allOptions = Array.from(ifaceSelect.options);
                const configuredSet = new Set(configuredInterfaces);

                const filterElements = (showAll) => {
                    allPortCards.forEach(card => {
                        const portName = card.querySelector('.port-name').innerText;
                        card.style.display = (showAll || configuredSet.has(portName)) ? 'flex' : 'none';
                    });
                    allOptions.forEach(option => {
                        if (option.value !== 'all') {
                            option.style.display = (showAll || configuredSet.has(option.value)) ? 'block' : 'none';
                        }
                    });
                };

                // Initial filter
                filterElements(false);

                // Add toggle switch
                const controls = document.querySelector('.controls');
                const toggleGroup = document.createElement('div');
                toggleGroup.className = 'control-group';
                toggleGroup.innerHTML = `
                    <label for="show_all_toggle"><%:Show All Interfaces%></label>
                    <input type="checkbox" id="show_all_toggle" style="width: auto; margin-top: 4px;">
                `;
                controls.insertBefore(toggleGroup, controls.children[1]);

                document.getElementById('show_all_toggle').addEventListener('change', function() {
                    filterElements(this.checked);
                });
            })
            .catch(error => console.error('Error fetching configured interfaces:', error));
    }

    window.clearHistory = function() {
        if(confirm('<%:Are you sure you want to delete all history logs?%>')) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '<%=luci.dispatcher.build_url("admin/status/interface_monitor/clear_logs")%>', true);
            xhr.onload = function() {
                if(xhr.status === 200) {
                    alert('<%:Logs cleared successfully.%>');
                    location.reload();
                } else {
                    alert('<%:Failed to clear logs.%>');
                }
            };
            xhr.send();
        }
    };
})();
</script>
<%+footer%>
