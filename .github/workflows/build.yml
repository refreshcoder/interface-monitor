name: Build OpenWrt Packages

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk_image: openwrt/sdk:x86-64-24.10.0
            tag: x86_64
          # - arch: mt7621
          #   sdk_image: openwrt/sdk:ramips-mt7621-24.10.0
          #   tag: ramips_mt7621
          # - arch: rockchip
          #   sdk_image: openwrt/sdk:rockchip-armv8-24.10.0
          #   tag: rockchip_armv8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Output Directory
        run: |
          mkdir -p bin_output
          chmod 777 bin_output

      - name: Prepare Cache Directories
        run: |
          mkdir -p .cache/openwrt/dl
          mkdir -p .cache/openwrt/staging_dir
          mkdir -p .cache/openwrt/build_dir
          mkdir -p .cache/openwrt/bin

      - name: Cache OpenWrt SDK build directories
        uses: actions/cache@v4
        with:
          path: |
            .cache/openwrt/dl
            .cache/openwrt/staging_dir
            .cache/openwrt/build_dir
          key: openwrt-24.10-${{ matrix.tag }}-${{ hashFiles('**/Makefile', '.github/workflows/build.yml') }}
          restore-keys: |
            openwrt-24.10-${{ matrix.tag }}-

      - name: Build Package
        run: |
          # Ensure source is readable by the docker user
          chmod -R 755 .
          
          # Run the build inside the OpenWrt SDK container (as root to avoid uid/gid permission issues)
          docker run --rm -u 0 \
            -v "$(pwd):/src" \
            -v "$(pwd)/.cache/openwrt/dl:/builder/dl" \
            -v "$(pwd)/.cache/openwrt/staging_dir:/builder/staging_dir" \
            -v "$(pwd)/.cache/openwrt/build_dir:/builder/build_dir" \
            ${{ matrix.sdk_image }} /bin/bash -c '
            # 0. Setup SDK if needed (OpenWrt 24.10+ requirement)
            [ -f setup.sh ] && ./setup.sh

            # 1. Update and install only required feeds to reduce time
            ./scripts/feeds update luci packages
            ./scripts/feeds install luci-base
            
            # 2. Copy our packages into the SDK package directory
            #    We use cp instead of direct mount to avoid permission issues with the build user
            cp -r /src/* package/
            
            # 3. Configure to build our packages
            echo "CONFIG_PACKAGE_interface-monitor=m" >> .config
            echo "CONFIG_PACKAGE_luci-app-interface-monitor=m" >> .config
            make defconfig
            
            # 4. Compile with verbose output to catch errors
            echo "Building packages in parallel..."
            make package/{interface-monitor,luci-app-interface-monitor}/compile -j$(nproc) V=s || exit 1
            
            # 5. Collect artifacts
            echo "Collecting packages..."
            # mkdir -p /src/bin_output # Created on host with 777 permissions
            chmod 777 /src/bin_output || true
            
            # Find and copy files with verbose output to ensure they are found
            find bin/packages -name "interface-monitor*.ipk" -exec cp -v {} /src/bin_output/ \;
            find bin/packages -name "luci-app-interface-monitor*.ipk" -exec cp -v {} /src/bin_output/ \;
            
            echo "Verifying collected artifacts in /src/bin_output:"
            ls -la /src/bin_output/
          '

      - name: Verify Artifacts on Host
        run: |
          echo "Checking bin_output directory on host:"
          ls -R bin_output

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-packages-${{ matrix.tag }}
          path: bin_output/*.ipk
          if-no-files-found: error
