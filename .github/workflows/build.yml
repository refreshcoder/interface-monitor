name: Build OpenWrt Packages

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk_image: openwrt/sdk:x86-64-24.10.0
            tag: x86_64
          # - arch: mt7621
          #   sdk_image: openwrt/sdk:ramips-mt7621-24.10.0
          #   tag: ramips_mt7621
          # - arch: rockchip
          #   sdk_image: openwrt/sdk:rockchip-armv8-24.10.0
          #   tag: rockchip_armv8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Output Directory
        run: |
          mkdir -p bin_output
          chmod 777 bin_output

      - name: Prepare Cache Directories
        run: |
          mkdir -p .cache/openwrt/dl
          mkdir -p .cache/openwrt/staging_dir
          mkdir -p .cache/openwrt/build_dir
          mkdir -p .cache/openwrt/bin

      - name: Cache OpenWrt SDK build directories
        uses: actions/cache@v4
        with:
          path: |
            .cache/openwrt/dl
          key: openwrt-24.10-${{ matrix.tag }}-${{ hashFiles('**/Makefile', '.github/workflows/build.yml') }}
          restore-keys: |
            openwrt-24.10-${{ matrix.tag }}-

      - name: Build Package
        run: |
          # Ensure source is readable by the docker user
          chmod -R 755 .
          
          # Run the build inside the OpenWrt SDK container (as root to avoid uid/gid permission issues)
          docker run --rm -u 0 -w /builder \
            -e BUILD_NUMBER="${{ github.run_number }}" \
            -e BUILD_SHA="${{ github.sha }}" \
            -e OPKG_SIGNING_PRIV="${{ secrets.OPKG_SIGNING_PRIV }}" \
            -e OPKG_SIGNING_PUB="${{ secrets.OPKG_SIGNING_PUB }}" \
            -v "$(pwd):/src" \
            -v "$(pwd)/.cache/openwrt/dl:/builder/dl" \
            ${{ matrix.sdk_image }} /bin/bash -c '
            [ ! -d ./scripts ] && ./setup.sh

            ./scripts/feeds update -a
            ./scripts/feeds install -a
            
            # 2. Copy our packages into the SDK package directory
            #    Restrict copy to our package dirs to avoid polluting SDK package/
            [ -d /src/interface-monitor ] && cp -r /src/interface-monitor package/
            [ -d /src/luci-app-interface-monitor ] && cp -r /src/luci-app-interface-monitor package/
            
            # 3. Configure to build our packages
            echo "CONFIG_PACKAGE_interface-monitor=m" >> .config
            echo "CONFIG_PACKAGE_luci-app-interface-monitor=m" >> .config
            make defconfig
            
            # 4. Compile with verbose output to catch errors
            echo "Building packages in parallel..."
            make package/{interface-monitor,luci-app-interface-monitor}/compile -j$(nproc) V=s || exit 1
            
            # 5. Collect artifacts
            echo "Collecting packages..."
            # mkdir -p /src/bin_output # Created on host with 777 permissions
            chmod 777 /src/bin_output || true
            BASE_DIR="/src/bin_output/openwrt-24.10/${{ matrix.tag }}/interface-monitor"
            mkdir -p "$BASE_DIR"
            
            # Find and copy files with verbose output to ensure they are found
            find bin/packages -name "interface-monitor*.ipk" -exec cp -v {} "$BASE_DIR/" \;
            find bin/packages -name "luci-app-interface-monitor*.ipk" -exec cp -v {} "$BASE_DIR/" \;

            echo "Generating package index..."
            if ! command -v sha256sum >/dev/null 2>&1; then
              if command -v apt-get >/dev/null 2>&1; then
                apt-get update && apt-get install -y coreutils busybox || true
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache coreutils busybox || true
              elif command -v dnf >/dev/null 2>&1; then
                dnf install -y coreutils busybox || true
              elif command -v yum >/dev/null 2>&1; then
                yum install -y coreutils busybox || true
              fi
            fi
            if ! command -v ar >/dev/null 2>&1; then
              if command -v apt-get >/dev/null 2>&1; then
                apt-get update && apt-get install -y binutils || true
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache binutils || true
              elif command -v dnf >/dev/null 2>&1; then
                dnf install -y binutils || true
              elif command -v yum >/dev/null 2>&1; then
                yum install -y binutils || true
              fi
            fi
            # Ensure hashing tools exist (fallback to busybox applets)
            command -v sha256sum >/dev/null 2>&1 || { command -v busybox >/dev/null 2>&1 && ln -sf "$(command -v busybox)" /usr/bin/sha256sum; }
            command -v md5sum >/dev/null 2>&1 || { command -v busybox >/dev/null 2>&1 && ln -sf "$(command -v busybox)" /usr/bin/md5sum; }
            command -v sha256 >/dev/null 2>&1 || { command -v sha256sum >/dev/null 2>&1 && ln -sf "$(command -v sha256sum)" /usr/bin/sha256; }
            ipk_count=$(ls -1 "$BASE_DIR"/*.ipk 2>/dev/null | wc -l || echo 0)
            echo "IPK count in $BASE_DIR: $ipk_count"
            ls -la "$BASE_DIR"
            if [ "$ipk_count" -eq 0 ]; then
              echo "Error: No IPK artifacts copied to $BASE_DIR. Failing early to surface build issues." >&2
              exit 2
            fi
            if [ -x ./scripts/ipkg-make-index.sh ]; then
              bash ./scripts/ipkg-make-index.sh "$BASE_DIR" > "$BASE_DIR/Packages" || true
            else
              ./scripts/ipkg-make-index.sh "$BASE_DIR" > "$BASE_DIR/Packages" || true
            fi
            if [ ! -s "$BASE_DIR/Packages" ]; then
              TMPIDX="/tmp/pkgidx"; mkdir -p "$TMPIDX"; : > "$BASE_DIR/Packages"
              for f in "$BASE_DIR"/*.ipk; do
                [ -f "$f" ] || continue
                ar p "$f" control.tar.gz > "$TMPIDX/ctrl.tgz" || continue
                tar -xOzf "$TMPIDX/ctrl.tgz" ./control > "$TMPIDX/control" || continue
                size=$(stat -c %s "$f" 2>/dev/null || wc -c < "$f")
                sha=$(sha256sum "$f" | awk '{print $1}')
                grep -E "^Package:|^Version:|^Architecture:|^Description:" "$TMPIDX/control" >> "$BASE_DIR/Packages"
                bn=$(basename "$f")
                printf "Filename: %s\n" "$bn" >> "$BASE_DIR/Packages"
                printf "Size: %s\n" "$size" >> "$BASE_DIR/Packages"
                printf "SHA256sum: %s\n\n" "$sha" >> "$BASE_DIR/Packages"
              done
            fi
            if [ -s "$BASE_DIR/Packages" ]; then gzip -9c "$BASE_DIR/Packages" > "$BASE_DIR/Packages.gz"; fi
            mkdir -p /src/bin_output/openwrt-24.10/keys
            if [ -n "$OPKG_SIGNING_PRIV" ]; then
              printf "%s\n" "$OPKG_SIGNING_PRIV" > /tmp/opkg_priv.key
              if [ -n "$OPKG_SIGNING_PUB" ]; then printf "%s\n" "$OPKG_SIGNING_PUB" > /src/bin_output/openwrt-24.10/keys/opkg_pub.key; fi
              if [ -x staging_dir/host/bin/usign ]; then
                staging_dir/host/bin/usign -S -m "$BASE_DIR/Packages" -s /tmp/opkg_priv.key -x "$BASE_DIR/Packages.sig"
              else
                usign -S -m "$BASE_DIR/Packages" -s /tmp/opkg_priv.key -x "$BASE_DIR/Packages.sig"
              fi
            fi

            echo "Verifying collected artifacts in $BASE_DIR:"
            ls -la "$BASE_DIR"
          '

      - name: Verify Artifacts on Host
        run: |
          echo "Checking bin_output directory on host:"
          ls -R bin_output

      - name: Generate Pages Index
        run: |
          set -e
          # Root index
          echo "<html><body><h2>Interface Monitor Feed</h2><ul>" > bin_output/index.html
          echo "<li><a href=\"openwrt-24.10/\">openwrt-24.10/</a></li>" >> bin_output/index.html
          if [ -d bin_output/openwrt-24.10/keys ]; then
            echo "<li><a href=\"openwrt-24.10/keys/opkg_pub.key\">openwrt-24.10/keys/opkg_pub.key</a></li>" >> bin_output/index.html
          fi
          echo "</ul></body></html>" >> bin_output/index.html

          # openwrt-24.10 index
          mkdir -p bin_output/openwrt-24.10
          echo "<html><body><h2>openwrt-24.10</h2><ul>" > bin_output/openwrt-24.10/index.html
          for d in bin_output/openwrt-24.10/*; do
            bn=$(basename "$d");
            if [ "$bn" != "index.html" ]; then
              echo "<li><a href=\"$bn/\">$bn/</a></li>" >> bin_output/openwrt-24.10/index.html
            fi
          done
          echo "</ul></body></html>" >> bin_output/openwrt-24.10/index.html

          # interface-monitor dir index (x86_64)
          if [ -d bin_output/openwrt-24.10/x86_64/interface-monitor ]; then
            echo "<html><body><h2>x86_64/interface-monitor</h2><ul>" > bin_output/openwrt-24.10/x86_64/interface-monitor/index.html
            for f in bin_output/openwrt-24.10/x86_64/interface-monitor/*; do
              bn=$(basename "$f");
              echo "<li><a href=\"$bn\">$bn</a></li>" >> bin_output/openwrt-24.10/x86_64/interface-monitor/index.html
            done
            echo "</ul></body></html>" >> bin_output/openwrt-24.10/x86_64/interface-monitor/index.html
          fi

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: bin_output

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-packages-${{ matrix.tag }}
          path: bin_output/**/*.ipk
          if-no-files-found: error

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
