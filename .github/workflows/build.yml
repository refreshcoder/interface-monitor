name: Build OpenWrt Packages

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk_image: openwrt/sdk:x86-64-24.10.0
            tag: x86_64
          # - arch: mt7621
          #   sdk_image: openwrt/sdk:ramips-mt7621-24.10.0
          #   tag: ramips_mt7621
          # - arch: rockchip
          #   sdk_image: openwrt/sdk:rockchip-armv8-24.10.0
          #   tag: rockchip_armv8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Output Directory
        run: |
          mkdir -p bin_output
          chmod 777 bin_output

      - name: Prepare Cache Directories
        run: |
          mkdir -p .cache/openwrt/dl
          mkdir -p .cache/openwrt/staging_dir
          mkdir -p .cache/openwrt/build_dir
          mkdir -p .cache/openwrt/bin

      - name: Cache OpenWrt SDK build directories
        uses: actions/cache@v4
        with:
          path: |
            .cache/openwrt/dl
          key: openwrt-24.10-${{ matrix.tag }}-${{ hashFiles('**/Makefile', '.github/workflows/build.yml') }}
          restore-keys: |
            openwrt-24.10-${{ matrix.tag }}-

      - name: Build Package
        run: |
          chmod -R 755 .
          docker run --rm -u 0 -w /builder \
            -e BUILD_NUMBER="${{ github.run_number }}" \
            -e BUILD_SHA="${{ github.sha }}" \
            -e ARCH_TAG="${{ matrix.tag }}" \
            -e HOST_UID="$(id -u)" \
            -e HOST_GID="$(id -g)" \
            -v "$(pwd):/src" \
            -v "$(pwd)/.cache/openwrt/dl:/builder/dl" \
            ${{ matrix.sdk_image }} /bin/bash -eu -o pipefail -c '
              bash /src/.github/scripts/build-ipk.sh
              chown -R "$HOST_UID:$HOST_GID" /src/bin_output
            '

      - name: Verify Artifacts on Host
        run: |
          echo "Checking bin_output directory on host:"
          ls -R bin_output

      - name: Upload Artifacts (Release Package)
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-packages-${{ matrix.tag }}
          path: bin_output/**/*.ipk
          if-no-files-found: error

      - name: Generate Index and Pages
        run: |
          # Reuse the SDK container for indexing to ensure compatibility, or we could use a lightweight container.
          # We use the same container to access 'usign' and 'ipkg-make-index.sh'
          docker run --rm -u 0 -w /builder \
            -e OPKG_SIGNING_PRIV="${{ secrets.OPKG_SIGNING_PRIV }}" \
            -e OPKG_SIGNING_PUB="${{ secrets.OPKG_SIGNING_PUB }}" \
            -e ARCH_TAG="${{ matrix.tag }}" \
            -e HOST_UID="$(id -u)" \
            -e HOST_GID="$(id -g)" \
            -v "$(pwd):/src" \
            ${{ matrix.sdk_image }} /bin/bash -eu -o pipefail -c '
              [ ! -d ./scripts ] && ./setup.sh
              bash /src/.github/scripts/gen-index.sh
              chown -R "$HOST_UID:$HOST_GID" /src/bin_output
            '
        continue-on-error: true

      - name: Generate Pages HTML
        run: |
          set -e
          cd bin_output
          # Use find to recursively visit all directories
          find . -type d | while read dir; do
            # Skip if index.html already exists (optional, but we overwrite to ensure consistency)
            echo "Generating index for $dir"
            
            # Start HTML
            echo "<html><head><meta charset=\"utf-8\"><title>Index of $dir</title></head><body>" > "$dir/index.html"
            echo "<h2>Index of $dir</h2><hr><ul>" >> "$dir/index.html"
            
            # Parent link (if not root)
            if [ "$dir" != "." ]; then
              echo "<li><a href=\"../\">../</a></li>" >> "$dir/index.html"
            fi
            
            # List children (directories and files)
            # We use a subshell to change directory safely
            (
              cd "$dir"
              # List directories first
              for d in */ ; do
                if [ -d "$d" ]; then
                  echo "<li><a href=\"$d\">$d</a></li>" >> "index.html"
                fi
              done
              # List files
              for f in *; do
                if [ -f "$f" ] && [ "$f" != "index.html" ]; then
                  echo "<li><a href=\"$f\">$f</a></li>" >> "index.html"
                fi
              done
            )
            
            # End HTML
            echo "</ul><hr></body></html>" >> "$dir/index.html"
          done

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: bin_output

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
